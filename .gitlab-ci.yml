workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "HW2"
    # только для определенной ветки HW2

default:
  tags:
    - C++


stages:          # List of stages for jobs, and their order of execution
  - build
  - test

build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
    - echo "Install gcc; cmake; clang"
    - apt-get -qq update && apt-get -qq install -y gcc
    - apt-get -qq install -y cmake
    - apt-get -qq install -y clang
    - echo "Installation complite"
    - echo "Compiling the code"
    - mkdir tmp
    - cmake -S . -B tmp
    - cmake --build tmp
    - echo "Compiling the code"
    - echo "Compile complete."
  artifacts:
    name: "cpp_executable"  
    paths:
      - ./tmp/main

# unit-test-job:   # This job runs in the test stage.
#   stage: test    # It only starts when the job in the build stage completes successfully.
#   script:
#     - echo "Running unit tests... This will take about 60 seconds."
#     - sleep 60
#     - echo "Code coverage is 90%"

valgrind-test-job:   # This job also runs in the test stage.
  stage: test    # It can run at the same time as unit-test-job (in parallel).
  rules:
    - exists:
      - ./tmp/main
      - Tests/Test.txt
  script:
    - echo "Install cppcheck"
    - apt-get -qq update && apt-get -qq install -y valgrind
    - echo "Installation complite"
    # - valgrind --leak-check=full ./tmp/main 'echo 1 | cat Tests/Test.txt | cat Tests/Test.txt | wc Tests/Test.txt'
    valgrind --xml=yes --xml-file="valgrind_log.xml" --leak-check=full ./tmp/main 'echo 1 | cat Test.txt | cat Test.txt | wc Test.txt'
    - echo "Complite valgrind test"
  artifacts:
    reports:
      junit: valgrind_log.xml
  # allow_failure: true

cppcheck-test-job:   # This job also runs in the test stage.
  stage: test    # It can run at the same time as unit-test-job (in parallel).
  script:
    - echo "Install cppcheck"
    - apt-get -qq update && apt-get -qq install -y cppcheck
    - echo "Installation complite"
    - cppcheck src/* header/*
    - echo "No lint issues found."
  # allow_failure: true
